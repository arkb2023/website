pipeline {
    agent any
    
    environment {
        DOCKER_IMAGE = 'arkb2023/website'
        KUBECONFIG = '/home/ubuntu/.kube/config'
    }
    
    stages {
        // 25th Release Gate
        stage('25th Release Gate') {
            steps {
                script {
                    def today = new Date()
                    def dayOfMonth = today[Calendar.DAY_OF_MONTH]
                    def branch = env.BRANCH_NAME ?: 'main'

                    echo "════════════════════════════════════════════════════"
                    echo "Release Gate Check"
                    echo "════════════════════════════════════════════════════"
                    echo "Current Date: ${today.format('yyyy-MM-dd HH:mm:ss')} (Day ${dayOfMonth}/25)"
                    echo "Branch: ${branch}"
                    echo "════════════════════════════════════════════════════"

                    // Set global variable for downstream stages
                    env.DEPLOY_APPROVED = (branch == 'main' && dayOfMonth == 18) ? 'true' : 'false'

                    if (env.DEPLOY_APPROVED == 'true') {
                        echo "Release Approved: Main branch on 25th - proceeding with K3s deployment"
                    } else {
                        if (branch != 'main') {
                            echo "Main branch commits only: Feature branch detected - skipping deployment"
                        }
                        if (dayOfMonth != 25) {
                            echo "25th release only: Current date is ${dayOfMonth} - skipping deployment"
                        }
                        echo "Build continues; deployment stage will be skipped"
                    }
                    echo ""
                }
            }
        }

        stage('Check Latest Docker Image') {
            steps {
                script {
                    // Get latest Docker Hub image digest
                    sh '''
                    LATEST_DIGEST=$(curl -s "https://hub.docker.com/v2/repositories/arkb2023/website/tags/latest" | jq -r '.images[0].digest')
                    echo "Latest Docker Hub digest: $LATEST_DIGEST"
                    echo "LATEST_DIGEST=$LATEST_DIGEST" > docker_image.env
                    '''
                }
            }
        }
        
        stage('Deploy Latest Image to K3s') {
            when {
                expression { env.DEPLOY_APPROVED == 'true' }
            }
            steps {
                script {
                    env.LATEST_DIGEST = sh(script: 'cat docker_image.env | cut -d= -f2', returnStdout: true).trim()
                    sh '''
                    export KUBECONFIG=/home/ubuntu/.kube/config
                    kubectl set image deployment/website-dep website=${DOCKER_IMAGE}:latest
                    kubectl rollout restart deployment/website-dep
                    kubectl rollout status deployment/website-dep --timeout=300s
                    '''
                }
            }
        }
        
        stage('Verify Deployment') {
            when {
                expression { env.DEPLOY_APPROVED == 'true' }
            }
            steps {
                sh '''
                export KUBECONFIG=/home/ubuntu/.kube/config
                kubectl get pods -l app=website -o wide
                kubectl get svc website-svc
                curl -s http://worker3:30008/ | head -20
                '''
            }
        }
    }
    
    post {
        success {
            script {
                if (env.DEPLOY_APPROVED == 'true') {
                    sh '''
                    export KUBECONFIG=/home/ubuntu/.kube/config
                    kubectl get pods,svc,deployments -o wide
                    '''
                    echo 'New Docker image deployed to K3s successfully!'
                } else {
                    echo 'Build completed successfully. Deployment skipped (not 25th or not main branch).'
                }
            }
        }
        failure {
            echo 'Build or deployment failed!'
            echo 'Check deployment logs for details.'
        }
    }
}
